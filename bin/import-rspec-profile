#!/usr/bin/env ruby

require 'csv'
require 'net/http'
require 'sqlite3'

if ARGV.size != 1
  STDERR.put "Usage: $0 <path-to-csv>"
end

# We store the results in the SQLite3 database in tmp/rspec_profiling, which is
# generated by this rake call.
system("rake", "rspec_profiling:install")
db = SQLite3::Database.new("tmp/rspec_profiling")

# Download the mentioned result and put it there.
# The user should commit and push (and then cancel the subsequent pipeline)
# after running this script.
rows = CSV.parse(File.read(ARGV[0]))

header = rows[0]
data = rows[1..-1]

# Interpolation. Yay.
column_names = header.map {|col| '"' + col + '"' }.join(', ')
binds = (['?'] * header.size).join(', ')
query = "INSERT INTO spec_profiling_results (#{column_names}) VALUES(#{binds})"

db.transaction do |tr|
  data.each do |row|
    next if row.empty?
    row[0].strip! # "03216fc567e8dd8ae65fbeaa4bfb2589ee8ea66c\n"
    tr.execute(query, row)
  end
end

db.close
puts "#{data.size} rows imported"
